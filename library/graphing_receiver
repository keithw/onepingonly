#!/usr/bin/python

from au_defs import *

import au_receive
import pygtk
import gtk
import gobject
import pyaudio

# Configuration
WIDTH=1024
HEIGHT=512
window_size = 2048
slice_size = 16

# Open soundcard
p = pyaudio.PyAudio()
soundcard_in = p.open(format = FORMAT,
                      channels = CHANNELS,
                      rate = SAMPLES_PER_SECOND,
                      input = True,
                      output = False,
                      frames_per_buffer = slice_size )

# Set up plot
window = gtk.Window(gtk.WINDOW_TOPLEVEL)
drawing_area = gtk.DrawingArea()
drawing_area.set_size_request(WIDTH, HEIGHT)
window.add( drawing_area )
drawing_area.show()
window.show()
drawable = drawing_area.window
pixmap = gtk.gdk.Pixmap(drawable, WIDTH, HEIGHT, depth=-1)
context = pixmap.new_gc()
colormap = drawing_area.get_colormap()
fgleft = colormap.alloc_color( "red" )
fgright = colormap.alloc_color( "blue" )
bg = colormap.alloc_color( "white" )
axes = colormap.alloc_color( "black" )
#guides = colormap.alloc_color( "blue" )
cursor = colormap.alloc_color( "green" )

sample_num = 0

receiver = au_receive.TwoChannelReceiver()

def makepoints( init_num, samples, firstpt ):
    points = []
    if ( firstpt[0] > 0 ):
        points.append( firstpt )
    for s in samples:
        x_coor = init_num * WIDTH / window_size
        y_coor = HEIGHT - ( HEIGHT / 2 + (HEIGHT/4) * s )
        points.append( (int(x_coor), int(y_coor)) )
#        points.append( (int(x_coor)+1, int(y_coor)) )
#        points.append( (int(x_coor), int(y_coor)+1) )
#        points.append( (int(x_coor)+1, int(y_coor)+1) )
        init_num += 1
    return points

saveleft = (0,0)
saveright = (0,0)

while True:
    # Receive audio
    left, right = receiver.receive( slice_size, soundcard_in, slice_size )

    assert( len(left) == slice_size )

    # Draw samples
    left_edge = sample_num * WIDTH / window_size
    left_pts = makepoints( sample_num, left, saveleft )
    right_pts = makepoints( sample_num, right, saveright )
    right_edge = left_pts[-1][0] + 2

    saveleft = left_pts[-1]
    saveright = right_pts[-1]

    sample_num += slice_size

    # Clear screen and draw guides
    context.foreground = bg
    pixmap.draw_rectangle( context, True, left_edge, 0, right_edge - left_edge, HEIGHT )
    context.foreground = axes
    pixmap.draw_line( context, 0, int(HEIGHT/2), WIDTH, int(HEIGHT/2) )
#    context.foreground = guides
#    pixmap.draw_line( context, 0, int(HEIGHT/4), WIDTH, int(HEIGHT/4) )
#    pixmap.draw_line( context, 0, int(3*HEIGHT/4), WIDTH, int(3*HEIGHT/4) )
    context.foreground = cursor
    pixmap.draw_line( context, right_edge, 0, right_edge, HEIGHT )

    # Draw points
    context.foreground = fgleft
    pixmap.draw_lines(context, left_pts)
    context.foreground = fgright
    pixmap.draw_lines(context, right_pts)

    drawable.draw_drawable( context, pixmap, 0, 0, 0, 0, -1, -1 )

    if sample_num >= window_size:
        sample_num = 0
        saveleft = (0,0)
        saveright = (0,0)
